#!/usr/bin/env python3
import os
import logging
import re
from datetime import datetime, timedelta

from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—ã–≤–æ–¥–æ–º –≤ –∫–æ–Ω—Å–æ–ª—å
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (–ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è)
TOKEN = "7501357038:AAFAonBpoHeZ2GxmOr7noPtP7VYMbehfmkE"
if not TOKEN:
    logger.error("–ù–µ –Ω–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –±–æ—Ç–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN.")
    exit(1)

# ------------------------- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª -------------------------

# 3.6, 3.7: –ó–∞–ø—Ä–µ—â—ë–Ω–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞ (–æ—Ç–∫—Ä—ã—Ç—ã–π –º–∞—Ç –∏ –µ–≥–æ –∑–∞–≤—É–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
BANNED_WORDS = [
    '—Ö—É–π', '–ø–∏–∑–¥–∞', '—Å—É–∫–∞', '–±–ª—è–¥—å', '–¥–∏–±–∏–ª', '–≥–∞–Ω–¥–æ–Ω', '–µ–±–ª–∞–Ω',
    '–µ–±–∞—Ç—å', '–µ–±–∞–ª', '–±–ª—è', '–±–ª—è–¥—ë—à–∫–∞', '–±–ª—è–¥–æ—ë–±–∏–Ω–∞', '–±–ª—è–¥–æ—ë–±–∏–Ω–∞ —Ö—É–µ—Ä–æ—Ç–∞—è'
]
BANNED_PATTERN = re.compile(r'\b(' + '|'.join(BANNED_WORDS) + r')\b', re.IGNORECASE)

# 3.17: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫
LINK_PATTERN = re.compile(
    r'((http|https)://)?'     # –ø—Ä–æ—Ç–æ–∫–æ–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    r'([\w.-]+)'              # –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –∏–ª–∏ IP
    r'(\.[a-zA-Z]{2,})'        # TLD
    r'([/\w .-]*)*/*'          # –ø—É—Ç—å
)

# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Å–ø–∞–º–∞/—Ä–µ–∫–ª–∞–º—ã
SPAM_KEYWORDS = ["–∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å", "—Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ", "120$", "–Ω–æ–≤–∏—á–∫–æ–≤", "–ø–∏—à–∏—Ç"]

# 3.2-3.4: –ü–∏—Ä–∞—Ç—Å—Ç–≤–æ, –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º
FRAUD_PIRACY_PATTERN = re.compile(
    r'\b(–º–æ—à–µ–Ω(?:–Ω–∏—á–µ—Å—Ç–≤–æ)?|–ø–∏—Ä–∞—Ç(?:—Å–∫–∏–π|—Å—Ç–≤–æ)?|–∑–∞–ø—Ä–µ—â—ë–Ω(?:–Ω—ã–µ|–Ω—ã–µ)\s+–ø—Ä–æ–≥—Ä–∞–º–º[—ã]?|–∫—Ä–∞–∫–µ—Ä|—á–∏—Ç–∞(?:—Ç—å|–Ω–∏–µ)?|–±–µ—Å–ø–ª–∞—Ç–Ω–æ\s+—Å–∫–∞—á–∞—Ç—å)\b',
    re.IGNORECASE
)

# 3.5: –í—ã–¥–∞—á–∞ —Å–µ–±—è –∑–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏
SELF_ADMIN_PATTERN = re.compile(r'\b(—è\s*(–∞–¥–º–∏–Ω|–º–æ–¥–µ—Ä–∞—Ç–æ—Ä))\b', re.IGNORECASE)

# 3.13: –ü—Ä–æ–ø–∞–≥–∞–Ω–¥–∞ –Ω–∞—Å–∏–ª–∏—è, –æ—Ä—É–∂–∏—è, –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤, –ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏–∏ –∏ —Ç.–ø.
DRUG_VIOLENCE_PATTERN = re.compile(
    r'\b(–Ω–∞—Ä–∫–æ—Ç–∏–∫(?:–∏)?|–æ—Ä—É–∂–∏–µ|–Ω–∞—Å–∏–ª–∏–µ|–ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏—è|—Å–µ–∫—Å—É–∞–ª—å–Ω—ã–π\s+–∫–æ–Ω—Ç–µ–Ω—Ç|–∞–ª–∫–æ–≥–æ–ª—å|—Ç–∞–±–∞–∫)\b',
    re.IGNORECASE
)

# 3.14: –ö–ª–µ–≤–µ—Ç–∞ –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
DEFAMATION_PATTERN = re.compile(r'\b(–∫–ª–µ–≤–µ—Ç(?:–∞)?|–ª–æ–∂–Ω–∞—è\s+–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è|—Ñ–µ–π–∫)\b', re.IGNORECASE)

# 3.10: –ó–∞—è–≤–ª–µ–Ω–∏—è –æ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–µ –æ–¥–Ω–æ–π –Ω–∞—Ü–∏–∏/–Ω–∞—Ä–æ–¥–∞ –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏
SUPERIORITY_PATTERN = re.compile(r'\b(–ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ|–ª—É—á—à–µ\s+–≤—Å–µ—Ö|—Å—É–ø—Ä–µ–º–∞—Å–∏)\b', re.IGNORECASE)

# 3.18: –¢—Ä–æ–ª–ª–∏–Ω–≥ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
TROLLING_PATTERN = re.compile(r'\b(—Ç—Ä–æ–ª–ª–∏—Ç—å|—Ç—Ä–æ–ª–ª–∏–Ω–≥|–ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è)\b', re.IGNORECASE)

# 3.20: –†–∞–∑–≥–ª–∞—à–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Ç–µ–ª–µ—Ñ–æ–Ω—ã, email –∏ —Ç.–ø.)
PERSONAL_INFO_PATTERN = re.compile(
    r'\b(\+?\d[\d\s\-]{7,}\d|[\w\.-]+@[\w\.-]+\.\w+)\b'
)

# ------------------------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -------------------------

def has_repeated_characters(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ–ª–µ–µ 3-—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ–¥—Ä—è–¥ (—Ñ–ª—É–¥)."""
    return bool(re.search(r'(.)\1{2,}', text))

def contains_link(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å—Å—ã–ª–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏."""
    return bool(LINK_PATTERN.search(text))

def is_mixed_alphabet_spam(text: str, threshold: float = 0.7) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –±—É–∫–≤—ã –Ω–µ –∏–∑ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã (–ø—Ä–∏–∑–Ω–∞–∫ —Å–ø–∞–º–∞)."""
    letters = [c for c in text if c.isalpha()]
    if not letters:
        return False
    cyrillic_count = sum(1 for c in letters if re.match(r'[–ê-–Ø–∞-—è–Å—ë]', c))
    return (cyrillic_count / len(letters)) < threshold

def log_deleted_message(message) -> None:
    """
    –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ —Ñ–∞–π–ª 'logs.txt' –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏:
    @alias | –ù–∏–∫ | –¥–∞—Ç–∞ | —Å–æ–æ–±—â–µ–Ω–∏–µ
    –û–±—ë—Ä—Ç–∫–∞ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –æ—à–∏–±–æ–∫ –∑–∞–ø–∏—Å–∏.
    """
    try:
        user = message.from_user
        username = "@" + (user.username if user.username else "unknown")
        nickname = user.full_name if user.full_name else "unknown"
        date_str = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        text = message.text
        log_entry = f"{username} | {nickname} | {date_str} | {text}\n"
        with open("logs.txt", "a", encoding="utf-8") as f:
            f.write(log_entry)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥-—Ñ–∞–π–ª: {e}")

async def delete_and_reply(message, reply_text: str) -> None:
    """
    –£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –ª–æ–≥–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é.
    –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ try/except –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.
    """
    try:
        await message.delete()
        log_deleted_message(message)
        await message.reply_text(reply_text)
        logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {message.from_user.id} —É–¥–∞–ª–µ–Ω–æ. –û—Ç–≤–µ—Ç: {reply_text}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

# ------------------------- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -------------------------

async def check_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–∞—Ö/—Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞—Ö
    if update.effective_chat.type not in ['group', 'supergroup']:
        return

    message = update.message
    if not message or not message.text:
        return

    # –ü—Ä–∏–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫
    text_original = message.text.strip()
    text = text_original.lower()

    # 3.1. –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —á–∞—Ç–∞
    if re.search(r'\b(–ø—Ä–∞–≤–∏–ª(?:–∞|—ã)?\s+—á–∞—Ç–∞)\b', text):
        await delete_and_reply(message, "–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —á–∞—Ç–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
        return

    # 3.2-3.4. –ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, –ø–∏—Ä–∞—Ç—Å—Ç–≤–æ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º
    if FRAUD_PIRACY_PATTERN.search(text):
        await delete_and_reply(message, "–û–±—Å—É–∂–¥–µ–Ω–∏–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞ –∏–ª–∏ –ø–∏—Ä–∞—Ç—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
        return

    # 3.5. –í—ã–¥–∞—á–∞ —Å–µ–±—è –∑–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if SELF_ADMIN_PATTERN.search(text):
        await delete_and_reply(message, "–í—ã–¥–∞—á–∞ —Å–µ–±—è –∑–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.")
        return

    # 3.6, 3.7. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ç–∞ –∏ –∑–∞–≤—É–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∞—Ç–∞
    if BANNED_PATTERN.search(text):
        await delete_and_reply(message, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–π –ª–µ–∫—Å–∏–∫–∏.")
        return

    # 3.8. –î–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è –∏ –Ω–∞—Ü–∏–æ–Ω–∞–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏—è
    hate_keywords = ['–Ω–∞—Ü–∏—è', '—Ä–∞—Å', '–µ–≤—Ä–µ–∏', '—á–µ—Ä–Ω—ã–µ', '–∞–∑–∏–∞—Ç—ã', '–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–º', '—Å—É–ø—Ä–µ–º–∞—Å–∏']
    if any(word in text for word in hate_keywords):
        await delete_and_reply(message, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.")
        return

    # 3.10. –ó–∞—è–≤–ª–µ–Ω–∏—è –æ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–µ (–µ—Å–ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã, —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ)
    if SUPERIORITY_PATTERN.search(text):
        await delete_and_reply(message, "–í—ã—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–∞ –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.")
        return

    # 3.13. –ü—Ä–æ–ø–∞–≥–∞–Ω–¥–∞ –Ω–∞—Å–∏–ª–∏—è, –æ—Ä—É–∂–∏—è, –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤, –ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏–∏ –∏ —Ç.–ø.
    if DRUG_VIOLENCE_PATTERN.search(text):
        await delete_and_reply(message, "–ü—Ä–æ–ø–∞–≥–∞–Ω–¥–∞ –Ω–∞—Å–∏–ª–∏—è, –æ—Ä—É–∂–∏—è, –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤ –∏–ª–∏ –ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.")
        return

    # 3.14. –ö–ª–µ–≤–µ—Ç–∞ –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    if DEFAMATION_PATTERN.search(text):
        await delete_and_reply(message, "–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –∫–ª–µ–≤–µ—Ç–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.")
        return

    # 3.15, 3.21. –£–≥—Ä–æ–∑—ã, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏—è
    threat_keywords = ['—É–±—å—é', '—Å–º–µ—Ä—Ç—å', '—É–≥—Ä–æ–∂–∞—é', '–Ω–∞–∫–∞–∂—É']
    if any(word in text for word in threat_keywords):
        await delete_and_reply(message, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∑–∞ —É–≥—Ä–æ–∑—ã –∏–ª–∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è.")
        return

    # 3.16. –§–ª—É–¥: –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if has_repeated_characters(text):
        await delete_and_reply(message, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∑–∞ —Ñ–ª—É–¥ (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã).")
        return

    # 3.17. –°–ø–∞–º, —Ä–µ–∫–ª–∞–º–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫
    if contains_link(text):
        await delete_and_reply(message, "–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∑–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Å—Å—ã–ª–æ–∫/—Ä–µ–∫–ª–∞–º—É.")
        return

    # 3.18. –¢—Ä–æ–ª–ª–∏–Ω–≥ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if TROLLING_PATTERN.search(text):
        await delete_and_reply(message, "–¢—Ä–æ–ª–ª–∏–Ω–≥ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã.")
        return

    # 3.19. –û–±—Å—É–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤/–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if (re.search(r'\b(–º–æ–¥–µ—Ä–∞—Ç–æ—Ä(—ã)?|–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è)\b', text) and
        re.search(r'\b(–æ–±—Å—É–∂–¥–µ–Ω–∏–µ|–∫—Ä–∏—Ç–∏–∫—É(?:—Ç—å)?|–∂–∞–ª–æ–±–∞)\b', text)):
        await delete_and_reply(message, "–û–±—Å—É–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
        return

    # 3.20. –†–∞–∑–≥–ª–∞—à–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    if PERSONAL_INFO_PATTERN.search(text):
        await delete_and_reply(message, "–†–∞–∑–≥–ª–∞—à–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
        return

    # 3.22. –ü–æ–ø—Ä–æ—à–∞–π–Ω–∏—á–µ—Å—Ç–≤–æ
    if re.search(r'\b(–ø–æ–∂–∞–ª—É–π—Å—Ç–∞,? –¥–∞–π—Ç–µ|–ø–æ–º–æ–≥–∏—Ç–µ –º–Ω–µ,? –ø–æ–∂–∞–ª—É–π—Å—Ç–∞)\b', text):
        await delete_and_reply(message, "–ü–æ–ø—Ä–æ—à–∞–π–Ω–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
        return

    # 3.23. –ù—ã—Ç—å—ë –∏ –≥–Ω—É—Å–∞–≤–æ—Å—Ç—å
    if re.search(r'\b(—Ö–Ω—ã–∫–∞—Ç—å|–Ω—ã—Ç—å|–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã)\b', text):
        await delete_and_reply(message, "–ù—ã—Ç—å—ë –≤ —á–∞—Ç–µ –Ω–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç—Å—è.")
        return

    # 4.1. –ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ CAPS LOCK (–µ—Å–ª–∏ –±–æ–ª–µ–µ 70% –±—É–∫–≤ ‚Äî –∑–∞–≥–ª–∞–≤–Ω—ã–µ)
    letters = [c for c in text if c.isalpha()]
    if letters:
        uppercase_count = sum(1 for c in letters if c.isupper())
        if len(letters) > 10 and (uppercase_count / len(letters)) > 0.7:
            await delete_and_reply(message, "–ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ CAPS LOCK –∑–∞–ø—Ä–µ—â–µ–Ω–æ.")
            return

    # 4.2. –ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ emoji (–µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ emoji –∏ –∏—Ö —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ)
    text_no_space = text_original.replace(" ", "")
    emoji_pattern = re.compile(
        "[\U0001F600-\U0001F64F"
        "\U0001F300-\U0001F5FF"
        "\U0001F680-\U0001F6FF"
        "\U0001F1E0-\U0001F1FF]+", flags=re.UNICODE
    )
    if text_no_space and emoji_pattern.fullmatch(text_no_space):
        count = context.user_data.get('emoji_count', 0) + 1
        context.user_data['emoji_count'] = count
        if count >= 5:
            await delete_and_reply(message, "–ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ emoji –Ω–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç—Å—è.")
            context.user_data['emoji_count'] = 0
            return
    else:
        context.user_data['emoji_count'] = 0

    # 4.4. –†–∞–∑–±–∏–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤
    words = text.split()
    if len(words) >= 5 and all(len(word) <= 2 for word in words):
        await delete_and_reply(message, "–†–∞–∑–±–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ.")
        return

    # 4.5. –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
    total_letters = [c for c in text if c.isalpha()]
    if total_letters:
        cyrillic_count = sum(1 for c in total_letters if re.match(r'[–ê-–Ø–∞-—è–Å—ë]', c))
        if (cyrillic_count / len(total_letters)) < 0.5:
            await delete_and_reply(message, "–°–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.")
            return

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º (—Å–º–µ—à–µ–Ω–∏–µ –∞–ª—Ñ–∞–≤–∏—Ç–æ–≤)
    if any(keyword in text for keyword in SPAM_KEYWORDS) and is_mixed_alphabet_spam(text):
        await delete_and_reply(message, "–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∫–∞–∫ —Å–ø–∞–º.")
        return

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π: –±–æ–ª–µ–µ 3 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 3 –º–∏–Ω—É—Ç—ã
    now = datetime.now()
    message_times = context.user_data.get('message_times', [])
    message_times = [t for t in message_times if now - t < timedelta(minutes=3)]
    message_times.append(now)
    context.user_data['message_times'] = message_times
    if len(message_times) > 3:
        await delete_and_reply(message, "–í—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–º–µ–¥–ª–∏—Ç–µ—Å—å.")
        context.user_data['message_times'] = []
        return

# ------------------------- –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ -------------------------

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–º–æ–¥–µ—Ä–∞—Ç–æ—Ä —á–∞—Ç–∞. –°–æ–±–ª—é–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞:\n"
        "- –ù–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞, —É–≥—Ä–æ–∑—ã –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã.\n"
        "- –§–ª—É–¥, —Å–ø–∞–º, —Å—Å—ã–ª–∫–∏ –∏ —Ä–µ–∫–ª–∞–º–∞ –Ω–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è.\n"
        "- –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∏ –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.\n"
        "–ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:\n"
        "/start ‚Äî –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞\n"
        "/rules ‚Äî –ø—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞\n"
        "/help ‚Äî –ø–æ–º–æ—â—å"
    )

async def rules(update: Update, context: ContextTypes.DEFAULT_TYPE):
    rules_text = (
        "üìö –ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞:\n\n"
        "‚ö†Ô∏è 1. –£—Å–ª–æ–≤–∏—è –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∞–≤–∏–ª —á–∞—Ç–∞\n"
        "‚ÄÉ‚ÄÉ1.1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∑–∞—Ö–æ–¥—è –≤ —á–∞—Ç, –ø—Ä–∏–Ω–∏–º–∞—é—Ç –Ω–∞ —Å–µ–±—è –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Å–æ–±–ª—é–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞.\n"
        "‚ÄÉ‚ÄÉ1.2. –ù–µ–∑–Ω–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.\n\n"
        "‚úÖ 2. –†–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –æ–±—â–µ–Ω–∏–µ, —à—É—Ç–∫–∏, –ø–æ–º–æ—â—å –∏ –æ–±–º–µ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.\n\n"
        "‚õî 3. –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ:\n"
        "‚ÄÉ‚ÄÉ3.1. –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —á–∞—Ç–∞.\n"
        "‚ÄÉ‚ÄÉ3.2. –ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, –ø–∏—Ä–∞—Ç—Å—Ç–≤–æ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º.\n"
        "‚ÄÉ‚ÄÉ3.3. –í—ã–¥–∞—á–∞ —Å–µ–±—è –∑–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n"
        "‚ÄÉ‚ÄÉ3.4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ç–∞ –∏ –∑–∞–≤—É–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ª–µ–∫—Å–∏–∫–∏.\n"
        "‚ÄÉ‚ÄÉ3.5. –î–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è, –Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–º –∏ —Ä–∞–∑–∂–∏–≥–∞–Ω–∏–µ –Ω–µ–Ω–∞–≤–∏—Å—Ç–∏.\n"
        "‚ÄÉ‚ÄÉ3.6. –§–ª—É–¥, —Å–ø–∞–º, —Ä–µ–∫–ª–∞–º–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫.\n"
        "‚ÄÉ‚ÄÉ3.7. –¢—Ä–æ–ª–ª–∏–Ω–≥, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–∏ –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤.\n"
        "‚ÄÉ‚ÄÉ3.8. –†–∞–∑–≥–ª–∞—à–µ–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n"
        "‚ÄÉ‚ÄÉ3.9. –£–≥—Ä–æ–∑—ã, –ø–æ–ø—Ä–æ—à–∞–π–Ω–∏—á–µ—Å—Ç–≤–æ, –Ω—ã—Ç—å—ë –∏ –≥–Ω—É—Å–∞–≤–æ—Å—Ç—å.\n\n"
        "‚ö†Ô∏è 4. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è—Ç—å Caps Lock, —Å–º–∞–π–ª–∞–º–∏, —Ä–∞–∑–±–∏–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ (–µ—Å–ª–∏ –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).\n\n"
        "‚úÖ 5. Emoji –¥–æ–ø—É—Å—Ç–∏–º—ã –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è —ç–º–æ—Ü–∏–π, –Ω–æ –∏—Ö –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ."
    )
    await update.message.reply_text(rules_text)

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    logger.error(msg="–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", exc_info=context.error)

# ------------------------- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ -------------------------

def main():
    application = Application.builder().token(TOKEN).build()

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö
    application.add_handler(CommandHandler("start", start, filters=filters.ChatType.GROUPS))
    application.add_handler(CommandHandler("rules", rules, filters=filters.ChatType.GROUPS))
    application.add_handler(CommandHandler("help", help_command, filters=filters.ChatType.GROUPS))
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∏—Å–∫–ª—é—á–∞—è –∫–æ–º–∞–Ω–¥—ã) —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –ø—Ä–∞–≤–∏–ª
    application.add_handler(MessageHandler(filters.ChatType.GROUPS & filters.TEXT & ~filters.COMMAND, check_message))
    application.add_error_handler(error_handler)

    application.run_polling()

if __name__ == '__main__':
    main()